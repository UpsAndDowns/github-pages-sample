<!DOCTYPE html>
<html>
  <head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta charset="utf-8" />
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" /> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- <link href="https://unpkg.com/sanitize.css" rel="stylesheet"/> -->
    <link href="style.css" rel="stylesheet" />
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet" />

    <title>動画比較再生</title>
  </head>
  <body style="margin: 0 auto">
    <div class="parent">
      <div class="video_pane">
        <div id="video_box1" class="video_box">
          <div class="video_container" id="v1container">
            <div class="file_container">
              <div align="center">
                <form>
                  <label>
                    <span class="arrow-button">
                      <i class="far fa-folder-open fa-3x arrow-color"></i>
                    </span>
                    <input style="display: none" id="LocalFile1" type="file" accept=".mp4,.MOV" />
                  </label>
                </form>
              </div>
              <div align="center">
                <button type="button" id="rangeAB1" class="arrow-button">
                  <font>A-B</font>
                </button>
              </div>
            </div>

            <video
              width="100%"
              height="100%"
              id="VideoID1"
              controls
              playsinline
              muted
              onTimeUpdate="handleTimeUpdate()"
            >
              <source src="" />
              <!-- ※ただしchromeやsafariではmuted属性で音が出ないようにしないと自動再生されません。 -->
            </video>
          </div>
          <div class="slider_control">
            <div id="slider1" class="middle">
              <input type="range" id="input-left1" min="0" max="100" value="0" />
              <input type="range" id="input-right1" min="0" max="100" value="100" />

              <div class="slider">
                <div class="track"></div>
                <div class="range"></div>
                <div class="thumb left"></div>
                <div class="thumb right"></div>
              </div>
            </div>
          </div>
        </div>
        <div id="video_box2" class="video_box">
          <div class="video_container" id="v2container">
            <div class="file_container">
              <div align="center">
                <form>
                  <label>
                    <span class="arrow-button">
                      <i class="far fa-folder-open fa-3x arrow-color"></i>
                    </span>
                    <input style="display: none" id="LocalFile2" type="file" accept=".mp4,.MOV" />
                  </label>
                </form>
              </div>
              <div align="center">
                <button type="button" id="rangeAB2" class="arrow-button">
                  <font>A-B</font>
                </button>
              </div>
            </div>
            <video width="100%" height="100%" id="VideoID2" controls="controls" playsinline="true" muted="true">
              <source src="" />
            </video>
          </div>
          <div class="slider_control">
            <div id="slider2" class="middle">
              <input type="range" id="input-left2" min="0" max="100" value="0" />
              <input type="range" id="input-right2" min="0" max="100" value="100" />

              <div class="slider">
                <div class="track"></div>
                <div class="range"></div>
                <div class="thumb left"></div>
                <div class="thumb right"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- スライダー位置を数字で表現するテストコード -->
        <!-- <div class="player_container" align="center">
            <span id="testLeft1"></span>
          </div>
          <div class="player_container" align="center">
            <span id="testRight1"></span>
          </div> -->
      </div>
      <!-- <div class="child file_control_pane"> -->
        <!-- videoタグ内にファイルオープンボタン埋め込んだので削除 -->
      <!-- </div> -->
      <!-- コマ送り、再生、一時停止ボタンを配置 -->
      <div id="player_control" class="child player_control_pane">
        <div class="player_container" align="center">
          <button type="button" name="Backward" value="Backward" class="arrow-button fas fa-backward fa-3x" onclick="funcVideoCtrl(BACKWARD)">
          </button>
        </div>
        <div class="player_container" align="center">
          <button
            type="button"
            id="stepBackward"
            value="Backward"
            class="arrow-button fas fa-step-backward fa-3x"
            onclick="funcVideoCtrl(STEPBACKWARD)"
          >
          </button>
        </div>
        <div class="player_container" align="center">
          <button type="button" id="Play" class="arrow-button fas fa-play fa-3x" onclick="funcVideoCtrl(PLAY)">
          </button>
        </div>
        <div class="player_container" align="center">
          <button
            type="button"
            id="stepForward"
            value="Forward"
            class="arrow-button fas fa-step-forward fa-3x"
            onclick="funcVideoCtrl(STEPFORWARD)"
          >
          </button>
        </div>
        <div class="player_container" align="center">
          <button type="button" name="Forward" value="Forward" class="arrow-button fas fa-forward fa-3x" onclick="funcVideoCtrl(FORWARD)">
          </button>
        </div>
      </div>
    </div>

    <iframe hidden name="hiddeniframe"></iframe>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script> -->
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script> -->
    <script type="text/javascript">
      // window.onorientationchange = function () {
      //   switch ( window.orientation ) {
      //     case 0:
      //       alert('画面を横にしてくださいね');
      //       break;
      //     case 90:
      //       break;
      //     case -90:
      //       break;
      //   }
      // }
      window.onload = function () {
        // スクロールを禁止にする関数
        function disableScroll(event) {
          event.preventDefault();
        }
      };
      const ON = 1;
      const OFF = 0;
      const STEPFORWARD = 1;
      const STEPBACKWARD = -1;
      const FORWARD = 2;
      const BACKWARD = -2;
      const PLAY = 3;
      const FrameAdvanceResolution = 0.05;
      const FOLDER1 = 1;
      const FOLDER2 = 2;
      const YOUTUBE1 = 3;
      const YOUTUBE2 = 4;

      const uploadImageModule = (() => {
        const inputElem1 = document.getElementById('LocalFile1');
        const inputElem2 = document.getElementById('LocalFile2');
        const previewElem1 = document.getElementById('VideoID1');
        const previewElem2 = document.getElementById('VideoID2');

        // 上のフォルダアイコンがクリックされたとき
        inputElem1.addEventListener('change', (event) => {
          event.preventDefault(); // デフォルトイベントのキャンセル
          event.stopPropagation(); // イベントのバブリングを防ぐ

          // type="file"を指定されたinput要素のchangeイベントは「ファイルのリスト」を返す
          const file = event.target.files[0];

          // ファイルが存在しないか、ファイル形式が"image/*"ではないとき
          if (!file || !file.type.match(/video\/*/)) {
            alert('Videoファイルではありません。');
            return false;
          }
          // FileReaderのインスタンスを生成（ローカルファイルを読み込むオブジェクト）
          const reader = new FileReader();

          // FileReaderの読み込みが完了した結果（アップロードした画像ファイルのデータ）を、img要素のsrcにセット
          reader.addEventListener('load', (event) => {
            // event.target.resultは、base64エンコードされた画像データ
            // previewElem1.setAttribute('src', event.target.result);
            // document.querySelector('video').src = URL.createObjectURL(file);
            previewElem1.src = URL.createObjectURL(file);
            funcSelectVideo(FOLDER1);
          });
          // 時間の長さを取得
          // const video = document.querySelector('video');
          // セットされたオブジェクトを読み込む
          reader.readAsDataURL(file);
          videoloaded[0] = ON;
        });

        // 下のフォルダアイコンがクリックされたとき
        inputElem2.addEventListener('change', (event) => {
          event.preventDefault(); // デフォルトイベントのキャンセル
          event.stopPropagation(); // イベントのバブリングを防ぐ

          // type="file"を指定されたinput要素のchangeイベントは「ファイルのリスト」を返す
          const file = event.target.files[0];

          // ファイルが存在しないか、ファイル形式が"image/*"ではないとき
          if (!file || !file.type.match(/video\/*/)) {
            alert('Videoファイルではありません。');
            return false;
          }
          // FileReaderのインスタンスを生成（ローカルファイルを読み込むオブジェクト）
          const reader = new FileReader();

          // FileReaderの読み込みが完了した結果（アップロードした画像ファイルのデータ）を、img要素のsrcにセット
          reader.addEventListener('load', (event) => {
            // event.target.resultは、base64エンコードされた画像データ
            // previewElem2.setAttribute('src', event.target.result);
            previewElem2.src = file.name;
            funcSelectVideo(FOLDER2);
          });
          // セットされたオブジェクトを読み込む
          reader.readAsDataURL(file);
          videoloaded[1] = ON;
        });
      })();

      var videoloaded = [OFF, OFF];
      var rangeABstep = [0, 0];
      var selectedisplay = 0; // 0:None, 1:only right, 2: Only left:, 3:both
      var PlayState = OFF;
      var v1_index = FOLDER1;
      var v2_index = FOLDER2;
      var b_play = document.getElementById('Play');
      var b_rangeAB = [document.getElementById('rangeAB1'), document.getElementById('rangeAB2')];
      var vid = [document.getElementById('VideoID1'), document.getElementById('VideoID2')];

      // Multi Handle Range Slider
      var inputLeft = [document.getElementById('input-left1'), document.getElementById('input-left2')];
      var inputRight = [document.getElementById('input-right1'), document.getElementById('input-right2')];

      var thumbLeft = document.querySelectorAll('.slider > .thumb.left'); // SelectorAllで全ての要素をリスト配列として格納
      var thumbRight = document.querySelectorAll('.slider > .thumb.right');
      var range = document.querySelectorAll('.slider > .range');

      function setLeftValue(index) {
        var _this = document.getElementById('input-left' + index), // 前が文字列で後ろが数値だと文字列になる
          min = parseInt(_this.min),
          max = parseInt(_this.max);

        _this.value = Math.min(
          parseInt(_this.value),
          parseInt(document.getElementById('input-right' + index).value) - 1
        );

        var percent = ((_this.value - min) / (max - min)) * 100;

        thumbLeft[index - 1].style.left = percent + '%';
        range[index - 1].style.left = percent + '%';
      }
      setLeftValue(1);
      setLeftValue(2);

      function setRightValue(index) {
        var _this = document.getElementById('input-right' + index), // 前が文字列で後ろが数値だと文字列になる
          min = parseInt(_this.min),
          max = parseInt(_this.max);

        _this.value = Math.max(
          parseInt(_this.value),
          parseInt(document.getElementById('input-left' + index).value) + 1
        );

        var percent = ((_this.value - min) / (max - min)) * 100;

        thumbRight[index - 1].style.right = 100 - percent + '%';
        range[index - 1].style.right = 100 - percent + '%';
      }
      setRightValue(1);
      setRightValue(2);

      // inputLeft[0].addEventListener("input", setLeftValue.bind(null, 1),false);
      // inputRight[0].addEventListener("input", setRightValue.bind(null, 1),false);
      // inputLeft[1].addEventListener("input", setLeftValue.bind(null, 2),false);
      // inputRight[1].addEventListener("input", setRightValue.bind(null, 2),false);

      document.getElementById('slider1').addEventListener('click', SelectedV1);
      // sliderをクリックして画面を選択
      function SelectedV1(e) {
        // const tgt = e.target;
        // console.log(document.getElementById('v1container').style.borderColor);
        if (document.getElementById('video_box1').style.borderColor != 'red') {
          document.getElementById('video_box1').style.borderColor = 'red';
          document.getElementById('player_control').style.borderColor = 'red';
          selectedisplay = 2;
        } else {
          document.getElementById('video_box1').style.borderColor = 'transparent';
          document.getElementById('player_control').style.borderColor = 'transparent';
          selectedisplay = 0;
        }
        document.getElementById('video_box2').style.borderColor = 'transparent';
      }

      document.getElementById('slider2').addEventListener('click', SelectedV2);
      // sliderをクリックして画面を選択
      function SelectedV2(e) {
        if (document.getElementById('video_box2').style.borderColor != 'green') {
          document.getElementById('video_box2').style.borderColor = 'green';
          document.getElementById('player_control').style.borderColor = 'green';
          selectedisplay = 1;
        } else {
          document.getElementById('video_box2').style.borderColor = 'transparent';
          document.getElementById('player_control').style.borderColor = 'transparent';
          selectedisplay = 0;
        }
        document.getElementById('video_box1').style.borderColor = 'transparent';
      }

      function handleTimeUpdate(e) {
        for (let i = 0; i < 2; i++) {
          if (vid[i].currentTime < (inputLeft[i].value / 100) * vid[i].duration) {
            if (vid[i].paused) {
              vid[i].currentTime = (inputLeft[i].value / 100) * vid[i].duration;
            } else {
              vid[i].currentTime = (inputLeft[i].value / 100) * vid[i].duration;
              vid[i].play();
            }
          }
          if (vid[i].currentTime > (inputRight[i].value / 100) * vid[i].duration) {
            vid[i].currentTime = (inputLeft[i].value / 100) * vid[i].duration;
          }
        }
      }

      document.getElementById('rangeAB1').addEventListener('click', function () {
        let i = 0;
          if (selectedisplay != i + 1) {
            if (rangeABstep[i] == 0) {
              inputLeft[i].value = (vid[i].currentTime / vid[i].duration) * 100;
              rangeABstep[i]++;
            } else if (rangeABstep[i] == 1) {
              inputRight[i].value = (vid[i].currentTime / vid[i].duration) * 100;
              rangeABstep[i]++;
            } else if (rangeABstep[i] == 2) {
              inputLeft[i].value = inputLeft[i].min;
              inputRight[i].value = inputRight[i].max;
              rangeABstep[i] = 0;
            }
            setLeftValue(i + 1);
            setRightValue(i + 1);
          }
        }
      );
      document.getElementById('rangeAB2').addEventListener('click', function () {
        let i = 1;
          if (selectedisplay != i + 1) {
            if (rangeABstep[i] == 0) {
              inputLeft[i].value = (vid[i].currentTime / vid[i].duration) * 100;
              rangeABstep[i]++;
            } else if (rangeABstep[i] == 1) {
              inputRight[i].value = (vid[i].currentTime / vid[i].duration) * 100;
              rangeABstep[i]++;
            } else if (rangeABstep[i] == 2) {
              inputLeft[i].value = inputLeft[i].min;
              inputRight[i].value = inputRight[i].max;
              rangeABstep[i] = 0;
            }
            setLeftValue(i + 1);
            setRightValue(i + 1);
          }
        }
      );

      // document.getElementById('Play').addEventListener('click', fav);
      // // 再生ボタンとポーズボタンのフォント切り替え
      // function fav(e) {
      //   const tgt = e.target;
      //   tgt.classList.toggle('fa-play');
      //   tgt.classList.toggle('fa-pause');
      // }

      var long_press_timer1;
      var long_press_timer2;
      const ua = navigator.userAgent.toLowerCase();
      const isSP = /iphone|ipod|ipad|android/.test(ua);
      const eventStart = isSP ? 'touchstart' : 'mousedown';
      const eventEnd = isSP ? 'touchend' : 'mouseup';
      const eventLeave = isSP ? 'touchmove' : 'mouseleave';
      var b_stepBackward = document.getElementById('stepBackward');
      var b_stepForward = document.getElementById('stepForward');
      b_stepBackward.addEventListener(eventStart, (e) => {
        e.preventDefault();
        if (selectedisplay != 1) vid[0].currentTime -= FrameAdvanceResolution;
        if (selectedisplay != 2) vid[1].currentTime -= FrameAdvanceResolution;
        long_press_timer1 = setInterval(() => {
          //１コマ戻す
          if (selectedisplay != 1) vid[0].currentTime -= FrameAdvanceResolution;
          if (selectedisplay != 2) vid[1].currentTime -= FrameAdvanceResolution;
        }, 100);
      });
      b_stepBackward.addEventListener(eventEnd, (e) => {
        e.preventDefault();
        clearInterval(long_press_timer1); //インターバルタイマのクリア
      });
      b_stepBackward.addEventListener(eventLeave, (e) => {
        e.preventDefault();
        let el;
        el = isSP ? document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY) : b;
        if (!isSP || el !== b_stepBackward) {
          clearInterval(long_press_timer1); //インターバルタイマのクリア
        }
      });

      b_stepForward.addEventListener(eventStart, (e) => {
        e.preventDefault();
        if (selectedisplay != 1) vid[0].currentTime += FrameAdvanceResolution;
        if (selectedisplay != 2) vid[1].currentTime += FrameAdvanceResolution;
        long_press_timer2 = setInterval(() => {
          //１コマ送る
          if (selectedisplay != 1) vid[0].currentTime += FrameAdvanceResolution;
          if (selectedisplay != 2) vid[1].currentTime += FrameAdvanceResolution;
        }, 100);
      });
      b_stepForward.addEventListener(eventEnd, (e) => {
        e.preventDefault();
        clearInterval(long_press_timer2); //インターバルタイマのクリア
      });
      b_stepForward.addEventListener(eventLeave, (e) => {
        e.preventDefault();
        let el;
        el = isSP ? document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY) : b;
        if (!isSP || el !== b_stepForward) {
          clearInterval(long_press_timer2); //インターバルタイマのクリア
        }
      });

      //再生、停止、コマ送り
      function funcVideoCtrl(index) {
        if (index == STEPBACKWARD) {
          // //１コマ戻す
          // if (selectedisplay != 1) vid[0].currentTime -= FrameAdvanceResolution;
          // if (selectedisplay != 2) vid[1].currentTime -= FrameAdvanceResolution;
        } else if (index == STEPFORWARD) {
          // if (selectedisplay != 1) vid[0].currentTime += FrameAdvanceResolution;
          // if (selectedisplay != 2) vid[1].currentTime += FrameAdvanceResolution;
        } else if (index == BACKWARD) {
          if (PlayState == OFF) {
            funcVideoCtrl(PLAY);
          }
          // if (isSP) {
          if (selectedisplay != 1) {  // 右側videoが選択されていない時
            if (vid[0].playbackRate > 0) {
              // 再生速度が0より進む方向
              vid[0].playbackRate = -1; // PC版Chromeは逆再生が対応していない
            } else {
              vid[0].playbackRate -= 1; // PC版Chromeは逆再生が対応していない
            }
          }
          if (selectedisplay != 2) {  // 左側videoが選択されていない時
            if (videoloaded[1] == ON) vid[1].play();
            if (vid[1].playbackRate > 0) {
              // 再生速度が0より進む方向
              vid[1].playbackRate = -1; // PC版Chromeは逆再生が対応していない
            } else {
              vid[1].playbackRate -= 1; // PC版Chromeは逆再生が対応していない
            }
          }
          // } else {
          // PC版Chromeは逆再生が対応していない
          // vid[0].currentTime = vid[0].currentTime - 3;
          // vid[1].currentTime = vid[1].currentTime - 3;
          // }
        } else if (index == FORWARD) {
          if (PlayState == OFF) {
            funcVideoCtrl(PLAY);
          }
          if (selectedisplay != 1) {  // 右側videoが選択されていない時
            if (vid[0].playbackRate < 0) {
              // 再生設定が早戻し中
              vid[0].playbackRate = 2;
            } else {
              vid[0].playbackRate += 1;
            }
          }
          if (selectedisplay != 2) {  // 左側videoが選択されていない時
            if (vid[1].playbackRate < 0) {
              // 再生設定が早戻し中
              vid[1].playbackRate = 2;
            } else {
              vid[1].playbackRate += 1;
            }
          }
        } else if (index == PLAY) {
          // 再生ボタンとポーズボタンのフォント切り替え
          b_play.classList.toggle('fa-play');
          b_play.classList.toggle('fa-pause');

          if (PlayState == OFF) {
            PlayState = ON;
            //動画を再生
            if (selectedisplay == 2) {
              vid[0].playbackRate = 1;
              if (videoloaded[0] == ON) vid[0].play();
            } else if (selectedisplay == 1) {
              vid[1].playbackRate = 1;
              if (videoloaded[1] == ON) vid[1].play();
            } else {
              if (videoloaded[0] == ON && videoloaded[1] == ON) {
                vid[0].playbackRate = 1;
                vid[1].playbackRate = 1;
                vid[0].play();
                vid[1].play();
              }
            }
          } else {
            PlayState = OFF;
            //動画を停止
            if (videoloaded[0] == ON && videoloaded[1] == ON) {
              vid[0].pause();
              vid[1].pause();
            } else if (videoloaded[0] == ON) {
              vid[0].pause();
            } else if (videoloaded[1] == ON) {
              vid[1].pause();
            }
          }
        }
      }
      // フォルダ、YOUTUBEマークをクリックしたときのイベントハンドラ
      function funcSelectVideo(index) {
        if (index == FOLDER1) {
          v1_index = FOLDER1;
          // document.getElementById('youtube-player1').parentNode.removeChild(document.getElementById('youtube-player1'));
          // vid[0].style.display = 'block';
        } else if (index == FOLDER2) {
          v2_index = FOLDER2;
          // vYouTube2.style.display = "none";
          // vid[1].style.display = 'block';
        }
      }
    </script>
  </body>
</html>